<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MicroMatch - AI Credit Matching Platform</title>
<meta name="description" content="Connecting micro-entrepreneurs to the right lenders with transparent AI-powered credit scoring">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    --card: 222.2 84% 4.9%;
    --card-foreground: 210 40% 98%;
    --popover: 222.2 84% 4.9%;
    --popover-foreground: 210 40% 98%;
    --primary: 217.2 91.2% 59.8%;
    --primary-foreground: 222.2 47.4% 11.2%;
    --secondary: 217.2 32.6% 17.5%;
    --secondary-foreground: 210 40% 98%;
    --muted: 217.2 32.6% 17.5%;
    --muted-foreground: 215 20.2% 65.1%;
    --accent: 142.1 76.2% 36.3%;
    --accent-foreground: 210 40% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 210 40% 98%;
    --border: 217.2 32.6% 17.5%;
    --input: 217.2 32.6% 17.5%;
    --ring: 224.3 76.3% 48%;
    --warning: 38 92% 50%;
    --warning-foreground: 0 0% 100%;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.6;
    color: hsl(var(--foreground));
    background: hsl(var(--background));
    min-height: 100vh;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  nav {
    background: hsl(var(--card) / 0.9);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid hsl(var(--border));
    position: sticky;
    top: 0;
    z-index: 100;
  }

  nav .container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.25rem;
    font-weight: bold;
  }

  .logo-icon {
    width: 32px;
    height: 32px;
    background: hsl(var(--primary));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: hsl(var(--primary-foreground));
    font-weight: bold;
  }

  .nav-buttons {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .btn {
    padding: 0.5rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }

  .btn-primary {
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
  }

  .btn-primary:hover {
    opacity: 0.9;
  }

  .btn-secondary {
    background: hsl(var(--secondary));
    color: hsl(var(--secondary-foreground));
    border: 1px solid hsl(var(--border));
  }

  .btn-secondary:hover {
    opacity: 0.8;
  }

  .btn-destructive {
    background: hsl(var(--destructive));
    color: hsl(var(--destructive-foreground));
  }

  .btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1.125rem;
  }

  .hero {
    text-align: center;
    padding: 5rem 1rem;
  }

  .hero h1 {
    font-size: 3.5rem;
    font-weight: bold;
    margin-bottom: 1.5rem;
    line-height: 1.2;
  }

  .hero .highlight {
    color: hsl(var(--primary));
  }

  .hero p {
    font-size: 1.5rem;
    color: hsl(var(--muted-foreground));
    margin-bottom: 2rem;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }

  .hero-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .card {
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .card-header {
    margin-bottom: 1rem;
  }

  .card-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
  }

  .card-description {
    color: hsl(var(--muted-foreground));
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid hsl(var(--border));
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    background: hsl(var(--background));
    color: hsl(var(--foreground));
  }

  .form-textarea {
    min-height: 120px;
    resize: vertical;
  }

  .form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: hsl(var(--primary));
    box-shadow: 0 0 0 3px hsl(var(--ring) / 0.2);
  }

  .progress {
    width: 100%;
    height: 8px;
    background: hsl(var(--secondary));
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: hsl(var(--primary));
    transition: width 0.3s;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .badge-pending {
    background: hsl(var(--muted));
    color: hsl(var(--muted-foreground));
  }

  .badge-approved {
    background: hsl(var(--accent));
    color: hsl(var(--accent-foreground));
  }

  .badge-rejected {
    background: hsl(var(--destructive));
    color: hsl(var(--destructive-foreground));
  }

  .grid {
    display: grid;
    gap: 1.5rem;
  }

  .grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  }

  .grid-3 {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .hidden {
    display: none !important;
  }

  .image-upload {
    border: 2px dashed hsl(var(--border));
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .image-upload:hover {
    border-color: hsl(var(--primary));
    background: hsl(var(--muted) / 0.5);
  }

  .image-preview {
    max-width: 100%;
    max-height: 300px;
    margin-top: 1rem;
    border-radius: 8px;
  }

  .yolo-result {
    margin-top: 1rem;
    padding: 1rem;
    background: hsl(var(--muted));
    border-radius: 8px;
    font-size: 0.875rem;
  }

  .chart-container {
    position: relative;
    height: 300px;
    margin-top: 1rem;
  }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
  }

  .modal-content {
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: 12px;
    padding: 1.5rem;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .timeline-item {
    position: relative;
    padding-left: 2.5rem;
    padding-bottom: 1.5rem;
  }

  .timeline-item:last-child {
    padding-bottom: 0;
  }

  .timeline-line {
    position: absolute;
    left: 0.75rem;
    top: 2rem;
    bottom: 0;
    width: 2px;
    background: hsl(var(--border));
  }

  .timeline-dot {
    position: absolute;
    left: 0.5rem;
    top: 0.5rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    background: hsl(var(--primary));
    border: 2px solid hsl(var(--background));
  }

  .timeline-dot.complete {
    background: hsl(var(--accent));
  }

  @media (max-width: 768px) {
    .hero h1 {
      font-size: 2rem;
    }
    .hero p {
      font-size: 1.125rem;
    }
  }
</style>
</head>
<body>
<nav id="navbar">
  <div class="container">
    <div class="logo">
      <div class="logo-icon">M</div>
      <span>MicroMatch</span>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </div>
</nav>

<div id="app"></div>
<div id="appModal" class="hidden"></div>

<script>
  const state = {
    currentView: 'landing',
    currentUser: null,
    applications: [],
    revenueData: []
  };

  function computeCreditScore(data) {
    const { monthlyIncome, loanAmount, loanPurpose, repaymentHistory, alternativeDataScore } = data;

    const ratio = monthlyIncome / loanAmount;
    let incomeScore = 0;
    if (ratio >= 0.5) incomeScore = 30;
    else if (ratio >= 0.3) incomeScore = 20;
    else if (ratio >= 0.2) incomeScore = 15;
    else incomeScore = 10;

    const descLength = loanPurpose.length;
    let descScore = 0;
    if (descLength >= 100) descScore = 25;
    else if (descLength >= 50) descScore = 20;
    else if (descLength >= 20) descScore = 15;
    else descScore = 10;

    const repaymentScore = repaymentHistory * 6;
    const altScore = alternativeDataScore * 3;

    const totalScore = incomeScore + descScore + repaymentScore + altScore;

    return {
      total: totalScore,
      breakdown: {
        'Income vs Loan': incomeScore,
        'Description Quality': descScore,
        'Repayment History': repaymentScore,
        'Alternative Data': altScore
      }
    };
  }

  function calculateInterestRate(creditScore) {
    if (creditScore >= 80) return 6.5;
    if (creditScore >= 70) return 8.0;
    if (creditScore >= 60) return 9.5;
    if (creditScore >= 50) return 11.0;
    if (creditScore >= 40) return 12.5;
    return 14.0;
  }

  function calculateRepaymentSchedule(loanAmount, interestRate, termMonths) {
    const monthlyRate = interestRate / 100 / 12;
    const monthlyPayment = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / 
                          (Math.pow(1 + monthlyRate, termMonths) - 1);
    
    let balance = loanAmount;
    const schedule = [];

    for (let month = 1; month <= termMonths; month++) {
      const interest = balance * monthlyRate;
      const principal = monthlyPayment - interest;
      balance -= principal;

      schedule.push({
        month,
        payment: monthlyPayment,
        principal,
        interest,
        balance: Math.max(0, balance)
      });
    }

    return schedule;
  }

  function calculateTotalPayback(loanAmount, interestRate, termMonths) {
    const monthlyRate = interestRate / 100 / 12;
    const monthlyPayment = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / 
                          (Math.pow(1 + monthlyRate, termMonths) - 1);
    return monthlyPayment * termMonths;
  }

  function loadUser() {
    const user = localStorage.getItem('mmCurrentUser');
    if (user) {
      state.currentUser = JSON.parse(user);
    }
  }

  function saveUser(user) {
    state.currentUser = user;
    localStorage.setItem('mmCurrentUser', JSON.stringify(user));
  }

  function logout() {
    state.currentUser = null;
    localStorage.removeItem('mmCurrentUser');
    state.currentView = 'landing';
    render();
  }

  function loadApplications() {
    if (state.currentUser) {
      if (state.currentUser.role === 'borrower') {
        const apps = localStorage.getItem(`mmApplications_${state.currentUser.id}`);
        state.applications = apps ? JSON.parse(apps) : [];
      } else if (state.currentUser.role === 'lender') {
        const apps = localStorage.getItem('mmAllApplications');
        state.applications = apps ? JSON.parse(apps) : [];
      }
    }
  }

  function saveApplication(app) {
    const borrowerApps = localStorage.getItem(`mmApplications_${app.borrowerId}`) || '[]';
    const apps = JSON.parse(borrowerApps);
    apps.push(app);
    localStorage.setItem(`mmApplications_${app.borrowerId}`, JSON.stringify(apps));

    const allApps = localStorage.getItem('mmAllApplications') || '[]';
    const allAppsArray = JSON.parse(allApps);
    allAppsArray.push(app);
    localStorage.setItem('mmAllApplications', JSON.stringify(allAppsArray));

    loadApplications();
  }

  function getRevenueData(borrowerId) {
    const data = localStorage.getItem(`mmRevenue_${borrowerId}`);
    if (data) return JSON.parse(data);

    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const initialData = months.map(month => ({
      month,
      revenue: Math.floor(Math.random() * 5000) + 2000,
      loans: 0
    }));
    saveRevenueData(borrowerId, initialData);
    return initialData;
  }

  function saveRevenueData(borrowerId, data) {
    localStorage.setItem(`mmRevenue_${borrowerId}`, JSON.stringify(data));
  }

  function updateRevenueWithLoan(borrowerId, loanAmount) {
    const data = getRevenueData(borrowerId);
    if (data.length > 0) {
      data[data.length - 1].loans += loanAmount;
      saveRevenueData(borrowerId, data);
    }
  }

  async function analyzeImageWithYOLO(imageFile) {
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    const mockResults = [
      { detected: ['id_card', 'text', 'photo'], confidence: 0.92, verified: true },
      { detected: ['document', 'text'], confidence: 0.78, verified: true },
      { detected: ['card'], confidence: 0.65, verified: false }
    ];
    
    const result = mockResults[Math.floor(Math.random() * mockResults.length)];
    
    return {
      detected: result.detected,
      confidence: result.confidence,
      verified: result.verified,
      message: result.verified ? 'ID verification successful' : 'Manual verification required'
    };
  }

  function init() {
    loadUser();
    loadApplications();
    render();
  }

  function render() {
    renderNav();
    renderContent();
  }

  function renderNav() {
    const navButtons = document.getElementById('navButtons');
    
    if (state.currentUser) {
      navButtons.innerHTML = `
        <span style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">${state.currentUser.name}</span>
        <button class="btn btn-secondary" onclick="logout()">Logout</button>
      `;
    } else {
      navButtons.innerHTML = `
        <button class="btn btn-secondary" onclick="showView('login')">Sign In</button>
        <button class="btn btn-primary" onclick="showView('signup')">Get Started</button>
      `;
    }
  }

  function renderContent() {
    const app = document.getElementById('app');
    
    switch(state.currentView) {
      case 'landing':
        app.innerHTML = renderLanding();
        break;
      case 'login':
        app.innerHTML = renderLogin();
        break;
      case 'signup':
        app.innerHTML = renderSignup();
        break;
      case 'borrower-dashboard':
        app.innerHTML = renderBorrowerDashboard();
        setTimeout(renderRevenueChart, 100);
        break;
      case 'borrower-apply':
        app.innerHTML = renderBorrowerApply();
        break;
      case 'lender-dashboard':
        app.innerHTML = renderLenderDashboard();
        break;
    }
  }

  function showView(view) {
    state.currentView = view;
    render();
  }

  function renderLanding() {
    return `
      <div class="hero">
        <div class="container">
          <h1>Connecting Micro-Entrepreneurs to the <span class="highlight">Right Lenders</span></h1>
          <p>No traditional credit score needed. Fair loans powered by transparent, data-driven AI for farmers, vendors, and more!</p>
          <div class="hero-buttons">
            <button class="btn btn-primary btn-lg" onclick="showView('signup')">Apply for Loan</button>
            <button class="btn btn-secondary btn-lg" onclick="showView('signup')">Become a Lender</button>
          </div>
        </div>
      </div>

      <div class="container" style="padding: 4rem 1rem;">
        <div class="grid grid-2">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üîç Transparent Scoring</h3>
              <p class="card-description">See exactly how your credit score is calculated with clear breakdowns!</p>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">‚ö° Fast Matching</h3>
              <p class="card-description">Get matched with the right lenders in minutes, not weeks!</p>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ü§ù Community Trust</h3>
              <p class="card-description">Build your reputation through community lending history!</p>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üíµ Fair Rates</h3>
              <p class="card-description">No middlemen means lower interest rates for borrowers!</p>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderLogin() {
    return `
      <div class="container" style="max-width: 500px; padding: 4rem 1rem;">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Welcome Back</h2>
            <p class="card-description">Sign in to your MicroMatch account</p>
          </div>
          <form onsubmit="handleLogin(event)">
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" name="email" required>
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" class="form-input" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
          </form>
          <p style="text-align: center; margin-top: 1rem; color: hsl(var(--muted-foreground));">
            Don't have an account? <a href="#" onclick="showView('signup'); return false;" style="color: hsl(var(--primary));">Sign up</a>
          </p>
        </div>
      </div>
    `;
  }

  function renderSignup() {
    return `
      <div class="container" style="max-width: 500px; padding: 4rem 1rem;">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Create Account</h2>
            <p class="card-description">Join MicroMatch today</p>
          </div>
          <form onsubmit="handleSignup(event)">
            <div class="form-group">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-input" name="name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" class="form-input" name="email" required>
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" class="form-input" name="password" required minlength="6">
            </div>
            <div class="form-group">
              <label class="form-label">I am a</label>
              <select class="form-select" name="role" required>
                <option value="">Select role</option>
                <option value="borrower">Borrower (seeking loan)</option>
                <option value="lender">Lender (providing loans)</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
          </form>
          <p style="text-align: center; margin-top: 1rem; color: hsl(var(--muted-foreground));">
            Already have an account? <a href="#" onclick="showView('login'); return false;" style="color: hsl(var(--primary));">Sign in</a>
          </p>
        </div>
      </div>
    `;
  }

  function renderBorrowerDashboard() {
    loadApplications();
    state.revenueData = getRevenueData(state.currentUser.id);
    
    return `
      <div class="container" style="padding: 2rem 1rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Welcome back, ${state.currentUser.name.split(' ')[0]}!</h1>
        <p style="color: hsl(var(--muted-foreground)); font-size: 1.125rem; margin-bottom: 2rem;">Manage your loan applications and track your credit score</p>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìä Business Revenue & Loans</h3>
            <p class="card-description">Track your monthly revenue and loan history</p>
          </div>
          <div class="chart-container">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary)) 100%); color: hsl(var(--primary-foreground)); border: none;">
          <div class="card-header">
            <h3 class="card-title">Apply for a New Loan</h3>
            <p style="opacity: 0.9;">Get matched with the right lenders using our transparent AI scoring system</p>
          </div>
          <button class="btn btn-lg" style="background: white; color: hsl(var(--primary));" onclick="showView('borrower-apply')">Start New Application</button>
        </div>

        <h2 style="font-size: 1.75rem; margin: 2rem 0 1rem;">Your Applications</h2>
        ${state.applications.length === 0 ? `
          <div class="card" style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
            <h3 style="margin-bottom: 0.5rem;">No applications yet</h3>
            <p style="color: hsl(var(--muted-foreground)); margin-bottom: 1.5rem;">Start your first loan application to get matched with lenders</p>
            <button class="btn btn-primary" onclick="showView('borrower-apply')">Create Application</button>
          </div>
        ` : state.applications.map(app => `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <div>
                <h3 style="font-size: 1.25rem; margin-bottom: 0.25rem;">$${(app.loanAmount || 0).toLocaleString()} Loan</h3>
                <p style="color: hsl(var(--muted-foreground));">${(app.loanPurpose || '').substring(0, 100)}...</p>
              </div>
              <span class="badge badge-${app.status || 'pending'}">${(app.status || 'pending').charAt(0).toUpperCase() + (app.status || 'pending').slice(1)}</span>
            </div>
            <div style="margin-bottom: 1rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span style="font-weight: 500;">Credit Score</span>
                <span style="font-size: 1.5rem; font-weight: bold; color: hsl(var(--primary));">${app.creditScore || 0}/100</span>
              </div>
              <div class="progress">
                <div class="progress-bar" style="width: ${app.creditScore || 0}%"></div>
              </div>
            </div>
            <div class="grid grid-2">
              ${app.scoreBreakdown ? Object.entries(app.scoreBreakdown).map(([key, value]) => `
                <div>
                  <div style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">${key}</div>
                  <div style="font-weight: 600;">${value || 0} pts</div>
                </div>
              `).join('') : ''}
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid hsl(var(--border)); font-size: 0.875rem; color: hsl(var(--muted-foreground));">
              Applied on ${new Date(app.createdAt).toLocaleDateString()}
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderRevenueChart() {
    const canvas = document.getElementById('revenueChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: state.revenueData.map(d => d.month),
        datasets: [
          {
            label: 'Revenue',
            data: state.revenueData.map(d => d.revenue),
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
            borderColor: 'rgb(59, 130, 246)',
            borderWidth: 1
          },
          {
            label: 'Loans',
            data: state.revenueData.map(d => d.loans),
            backgroundColor: 'rgba(16, 185, 129, 0.5)',
            borderColor: 'rgb(16, 185, 129)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: 'rgb(210, 214, 220)' }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: 'rgb(210, 214, 220)' },
            grid: { color: 'rgba(255, 255, 255, 0.1)' }
          },
          x: {
            ticks: { color: 'rgb(210, 214, 220)' },
            grid: { color: 'rgba(255, 255, 255, 0.1)' }
          }
        }
      }
    });
  }

  function renderBorrowerApply() {
    return `
      <div class="container" style="max-width: 800px; padding: 2rem 1rem;">
        <button class="btn btn-secondary" onclick="showView('borrower-dashboard')" style="margin-bottom: 1rem;">‚Üê Back to Dashboard</button>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Loan Application</h2>
            <p class="card-description">Fill out your information to get your transparent credit score</p>
          </div>
          
          <form onsubmit="handleApplicationSubmit(event)">
            <div class="form-group">
              <label class="form-label">Monthly Income ($)</label>
              <input type="number" class="form-input" name="monthlyIncome" required min="0" step="0.01">
            </div>

            <div class="form-group">
              <label class="form-label">Loan Amount Requested ($)</label>
              <input type="number" class="form-input" name="loanAmount" required min="0" step="0.01">
            </div>

            <div class="form-group">
              <label class="form-label">Loan Term (months)</label>
              <select class="form-select" name="termMonths" required>
                <option value="">Select term</option>
                <option value="6">6 months</option>
                <option value="12">12 months</option>
                <option value="24">24 months</option>
                <option value="36">36 months</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Loan Purpose</label>
              <textarea class="form-textarea" name="loanPurpose" required placeholder="Describe how you will use this loan and how it will help your business..."></textarea>
              <small style="color: hsl(var(--muted-foreground));">Detailed descriptions improve your credit score</small>
            </div>

            <div class="form-group">
              <label class="form-label">Repayment History (0-5)</label>
              <select class="form-select" name="repaymentHistory" required>
                <option value="">Select your history</option>
                <option value="0">0 - No previous loans</option>
                <option value="1">1 - Poor history</option>
                <option value="2">2 - Fair history</option>
                <option value="3">3 - Good history</option>
                <option value="4">4 - Very good history</option>
                <option value="5">5 - Excellent history</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Upload ID for Verification (YOLO Detection)</label>
              <div class="image-upload" onclick="document.getElementById('idUpload').click()">
                <input type="file" id="idUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <div id="uploadText">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∑</div>
                  <p>Click to upload your ID card</p>
                  <small style="color: hsl(var(--muted-foreground));">AI will verify your identity</small>
                </div>
                <img id="imagePreview" class="image-preview hidden">
              </div>
              <div id="yoloResult" class="yolo-result hidden"></div>
            </div>

            <input type="hidden" name="alternativeDataScore" id="alternativeDataScore" value="3">

            <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">Submit Application</button>
          </form>
        </div>
      </div>
    `;
  }

  function renderLenderDashboard() {
    loadApplications();
    const pendingCount = state.applications.filter(app => app.status === 'pending').length;
    const approvedCount = state.applications.filter(app => app.status === 'approved').length;

    return `
      <div class="container" style="padding: 2rem 1rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">Lender Dashboard</h1>
        <p style="color: hsl(var(--muted-foreground)); font-size: 1.125rem; margin-bottom: 2rem;">Review borrower applications with transparent AI credit scores</p>

        <div class="grid grid-3" style="margin-bottom: 2rem;">
          <div class="card">
            <p style="color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem;">Total Applications</p>
            <h3 style="font-size: 2rem; font-weight: bold;">${state.applications.length}</h3>
          </div>
          <div class="card">
            <p style="color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem;">Pending Review</p>
            <h3 style="font-size: 2rem; font-weight: bold;">${pendingCount}</h3>
          </div>
          <div class="card">
            <p style="color: hsl(var(--muted-foreground)); margin-bottom: 0.5rem;">Approved</p>
            <h3 style="font-size: 2rem; font-weight: bold; color: hsl(var(--accent));">${approvedCount}</h3>
          </div>
        </div>

        <h2 style="font-size: 1.75rem; margin-bottom: 1rem;">Borrower Applications</h2>
        ${state.applications.length === 0 ? `
          <div class="card" style="text-align: center; padding: 3rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
            <h3 style="margin-bottom: 0.5rem;">No applications yet</h3>
            <p style="color: hsl(var(--muted-foreground));">Waiting for borrowers to submit applications</p>
          </div>
        ` : state.applications.map(app => {
          const score = app.creditScore || 0;
          const loanAmt = app.loanAmount || 0;
          const monthlyInc = app.monthlyIncome || 0;
          const intRate = app.interestRate || 0;
          const status = app.status || 'pending';
          const purpose = app.loanPurpose || 'No description';
          const created = app.createdAt || new Date().toISOString();
          
          return `
          <div class="card" style="cursor: pointer;" onclick='viewApplicationDetails(${JSON.stringify(app).replace(/'/g, "&#39;")})'>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                  <h3 style="font-size: 1.25rem;">${app.borrowerName || 'Unknown'}</h3>
                  <span class="badge badge-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                </div>
                <p style="color: hsl(var(--muted-foreground));">${purpose.substring(0, 100)}...</p>
              </div>
              <div style="text-align: right; margin-left: 1rem;">
                <div style="font-size: 2rem; font-weight: bold; color: hsl(var(--primary));">${score}</div>
                <div style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">Credit Score</div>
              </div>
            </div>
            <div class="progress" style="margin-bottom: 1rem;">
              <div class="progress-bar" style="width: ${score}%"></div>
            </div>
            <div class="grid grid-2">
              <div>
                <div style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">Loan Amount</div>
                <div style="font-weight: 600;">${loanAmt.toLocaleString()}</div>
              </div>
              <div>
                <div style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">Monthly Income</div>
                <div style="font-weight: 600;">${monthlyInc.toLocaleString()}</div>
              </div>
              <div>
                <div style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">Interest Rate</div>
                <div style="font-weight: 600;">${intRate > 0 ? intRate.toFixed(1) + '%' : 'N/A'}</div>
              </div>
              <div>
                <div style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">Applied</div>
                <div style="font-weight: 600;">${new Date(created).toLocaleDateString()}</div>
              </div>
            </div>
          </div>
        `;
        }).join('')}
      </div>
    `;
  }

  function handleLogin(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const email = formData.get('email');
    const password = formData.get('password');

    const users = JSON.parse(localStorage.getItem('mmUsers') || '[]');
    const user = users.find(u => u.email === email && u.password === password);

    if (user) {
      saveUser(user);
      state.currentView = user.role === 'borrower' ? 'borrower-dashboard' : 'lender-dashboard';
      render();
    } else {
      alert('Invalid credentials');
    }
  }

  function handleSignup(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    const user = {
      id: Date.now().toString(),
      name: formData.get('name'),
      email: formData.get('email'),
      password: formData.get('password'),
      role: formData.get('role')
    };

    const users = JSON.parse(localStorage.getItem('mmUsers') || '[]');
    users.push(user);
    localStorage.setItem('mmUsers', JSON.stringify(users));

    saveUser(user);
    state.currentView = user.role === 'borrower' ? 'borrower-dashboard' : 'lender-dashboard';
    render();
  }

  async function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(event) {
      const preview = document.getElementById('imagePreview');
      preview.src = event.target.result;
      preview.classList.remove('hidden');
      document.getElementById('uploadText').classList.add('hidden');
    };
    reader.readAsDataURL(file);

    const resultDiv = document.getElementById('yoloResult');
    resultDiv.innerHTML = '<p>üîÑ Analyzing ID with YOLO...</p>';
    resultDiv.classList.remove('hidden');

    try {
      const result = await analyzeImageWithYOLO(file);
      
      if (result.verified) {
        resultDiv.innerHTML = `
          <p style="color: hsl(var(--accent)); font-weight: 600;">‚úÖ Approved!</p>
          <p style="margin-top: 0.5rem;">Detected: ${result.detected.join(', ')}</p>
          <p>Confidence: ${(result.confidence * 100).toFixed(1)}%</p>
        `;
        document.getElementById('alternativeDataScore').value = '5';
      } else {
        resultDiv.innerHTML = `
          <p style="font-weight: 600;">‚úÖ Approved, will be forwarded to the human.</p>
          <p style="margin-top: 0.5rem;">Thank you for choosing MicroMatch!</p>
        `;
        document.getElementById('alternativeDataScore').value = '2';
      }
    } catch (error) {
      resultDiv.innerHTML = `<p style="color: hsl(var(--destructive));">Error analyzing image</p>`;
    }
  }

  function handleApplicationSubmit(e) {
    e.preventDefault();
    const formData = new FormData(e.target);

    const data = {
      monthlyIncome: parseFloat(formData.get('monthlyIncome')),
      loanAmount: parseFloat(formData.get('loanAmount')),
      termMonths: parseInt(formData.get('termMonths')),
      loanPurpose: formData.get('loanPurpose'),
      repaymentHistory: parseInt(formData.get('repaymentHistory')),
      alternativeDataScore: parseInt(formData.get('alternativeDataScore'))
    };

    const score = computeCreditScore(data);
    const interestRate = calculateInterestRate(score.total);
    const repaymentSchedule = calculateRepaymentSchedule(data.loanAmount, interestRate, data.termMonths);

    const application = {
      id: Date.now().toString(),
      borrowerId: state.currentUser.id,
      borrowerName: state.currentUser.name,
      borrowerEmail: state.currentUser.email,
      ...data,
      creditScore: score.total,
      scoreBreakdown: score.breakdown,
      interestRate: interestRate,
      repaymentSchedule: repaymentSchedule,
      status: 'pending',
      createdAt: new Date().toISOString()
    };

    updateRevenueWithLoan(state.currentUser.id, data.loanAmount);
    saveApplication(application);
    state.currentView = 'borrower-dashboard';
    render();
    alert('Application submitted successfully!');
  }

  function viewApplicationDetails(app) {
    const totalPayback = calculateTotalPayback(app.loanAmount, app.interestRate, app.termMonths);
    const totalInterest = totalPayback - app.loanAmount;
    const monthlyPayment = app.repaymentSchedule && app.repaymentSchedule[0] ? app.repaymentSchedule[0].payment : 0;

    const betterRate = Math.max(5.5, app.interestRate - 2);
    const worseRate = Math.min(15, app.interestRate + 3);
    const betterPayback = calculateTotalPayback(app.loanAmount, betterRate, app.termMonths);
    const worsePayback = calculateTotalPayback(app.loanAmount, worseRate, app.termMonths);

    const milestones = app.repaymentSchedule ? app.repaymentSchedule.filter((_, index) => 
      index === 0 || (index + 1) % 6 === 0 || index === app.repaymentSchedule.length - 1
    ) : [];

    const modal = document.getElementById('appModal');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
          <div>
            <h2 style="font-size: 1.5rem; margin-bottom: 0.25rem;">${app.borrowerName}</h2>
            <p style="color: hsl(var(--muted-foreground));">Application Details & Analysis</p>
          </div>
          <button class="btn btn-secondary" onclick="closeModal()">‚úï</button>
        </div>

        <div style="text-align: center; padding: 2rem; background: hsl(var(--muted)); border-radius: 8px; margin-bottom: 1.5rem;">
          <div style="font-size: 3rem; font-weight: bold; color: hsl(var(--primary)); margin-bottom: 0.5rem;">${app.creditScore}/100</div>
          <div class="progress" style="max-width: 300px; margin: 0 auto;">
            <div class="progress-bar" style="width: ${app.creditScore}%"></div>
          </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, hsl(var(--card)) 0%, hsl(var(--card)) 100%); border: 1px solid hsl(var(--border));">
          <div class="card-header">
            <h3 class="card-title">üí∞ Interest Rate Analysis</h3>
            <p class="card-description">Based on credit score of ${app.creditScore}/100</p>
          </div>
          <div style="text-align: center; padding: 1.5rem; background: hsl(var(--muted) / 0.5); border-radius: 8px; margin-bottom: 1rem;">
            <div style="font-size: 3rem; font-weight: bold; color: hsl(var(--primary));">${app.interestRate.toFixed(1)}%</div>
            <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Annual Percentage Rate (APR)</div>
          </div>
          <div class="grid grid-2" style="margin-bottom: 1rem;">
            <div style="padding: 1rem; background: hsl(var(--muted) / 0.5); border-radius: 8px;">
              <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Monthly Payment</div>
              <div style="font-size: 1.5rem; font-weight: bold;">${monthlyPayment.toFixed(2)}</div>
            </div>
            <div style="padding: 1rem; background: hsl(var(--muted) / 0.5); border-radius: 8px;">
              <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Total Interest</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: hsl(var(--secondary));">${Math.round(totalInterest).toLocaleString()}</div>
            </div>
          </div>
          <div style="padding: 1rem; background: hsl(var(--primary) / 0.1); border: 2px solid hsl(var(--primary) / 0.5); border-radius: 8px; margin-bottom: 1rem;">
            <div style="font-size: 0.875rem; font-weight: 600; color: hsl(var(--muted-foreground));">Total Amount to Repay</div>
            <div style="font-size: 2rem; font-weight: bold; color: hsl(var(--primary));">${Math.round(totalPayback).toLocaleString()}</div>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: hsl(var(--accent) / 0.1); border-radius: 8px; margin-bottom: 0.5rem;">
              <span style="font-size: 0.875rem;">With ${betterRate.toFixed(1)}% rate</span>
              <span style="font-weight: 600; color: hsl(var(--accent));">${Math.round(betterPayback).toLocaleString()}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: hsl(var(--destructive) / 0.1); border-radius: 8px;">
              <span style="font-size: 0.875rem;">With ${worseRate.toFixed(1)}% rate</span>
              <span style="font-weight: 600; color: hsl(var(--destructive));">${Math.round(worsePayback).toLocaleString()}</span>
            </div>
          </div>
        </div>

        <div class="card" style="border: 1px solid hsl(var(--border));">
          <div class="card-header">
            <h3 class="card-title">‚è≥ Repayment Timeline</h3>
            <p class="card-description">${app.termMonths} monthly payments at ${monthlyPayment.toFixed(2)}/month</p>
          </div>
          <div class="grid grid-3" style="margin-bottom: 1.5rem;">
            <div style="padding: 1rem; background: hsl(var(--muted) / 0.5); border-radius: 8px;">
              <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Loan Amount</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: hsl(var(--primary));">${app.loanAmount.toLocaleString()}</div>
            </div>
            <div style="padding: 1rem; background: hsl(var(--muted) / 0.5); border-radius: 8px;">
              <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Interest Rate</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: hsl(var(--secondary));">${app.interestRate.toFixed(1)}%</div>
            </div>
            <div style="padding: 1rem; background: hsl(var(--muted) / 0.5); border-radius: 8px;">
              <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">Total Payback</div>
              <div style="font-size: 1.5rem; font-weight: bold; color: hsl(var(--accent));">${Math.round(totalPayback).toLocaleString()}</div>
            </div>
          </div>
          <div style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; margin-bottom: 0.5rem;">
              <span style="color: hsl(var(--muted-foreground));">Total Interest</span>
              <span style="font-weight: 600;">${Math.round(totalInterest).toLocaleString()}</span>
            </div>
            <div class="progress">
              <div class="progress-bar" style="width: ${(totalInterest / totalPayback) * 100}%"></div>
            </div>
          </div>
          <div style="font-weight: 600; margin-bottom: 1rem;">Payment Milestones</div>
          ${milestones.map((payment, index) => {
            const isFirst = index === 0;
            const isLast = index === milestones.length - 1;
            const progressPercent = ((payment.month) / app.termMonths) * 100;
            
            return `
              <div class="timeline-item">
                ${!isLast ? '<div class="timeline-line"></div>' : ''}
                <div class="timeline-dot ${isLast ? 'complete' : ''}"></div>
                <div style="padding: 1rem; background: hsl(var(--muted) / 0.3); border-radius: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                      <div style="font-weight: 600;">
                        ${isFirst ? 'Start - ' : ''}Month ${payment.month}${isLast ? ' - Final Payment' : ''}
                      </div>
                      <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                        Remaining: ${Math.round(payment.balance).toLocaleString()}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 0.875rem; font-weight: 500;">${payment.payment.toFixed(2)}</div>
                      <div style="font-size: 0.75rem; color: hsl(var(--muted-foreground));">
                        ${progressPercent.toFixed(0)}% complete
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
          <div style="padding: 1rem; background: hsl(var(--accent) / 0.1); border: 1px solid hsl(var(--accent) / 0.5); border-radius: 8px; margin-top: 1rem;">
            <div style="font-size: 0.875rem; font-weight: 600; color: hsl(var(--accent-foreground));">Estimated Loan Payoff</div>
            <div style="font-size: 1.5rem; font-weight: bold; margin-top: 0.5rem;">
              ${new Date(Date.now() + app.termMonths * 30 * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', {
                month: 'long',
                year: 'numeric',
              })}
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="font-weight: 600; margin-bottom: 1rem;">Transparent Score Breakdown</h3>
          ${Object.entries(app.scoreBreakdown).map(([key, value]) => {
            const maxPoints = key === 'Income vs Loan' ? 30 : key === 'Description Quality' ? 25 : key === 'Repayment History' ? 30 : 15;
            return `
              <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                  <span style="font-weight: 500;">${key}</span>
                  <span style="font-weight: 600;">${value}/${maxPoints} pts</span>
                </div>
                <div class="progress">
                  <div class="progress-bar" style="width: ${(value / maxPoints) * 100}%"></div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        <div class="grid grid-2" style="padding-top: 1rem; border-top: 1px solid hsl(var(--border)); margin-bottom: 1.5rem;">
          <div>
            <div style="color: hsl(var(--muted-foreground)); font-size: 0.875rem; margin-bottom: 0.25rem;">Monthly Income</div>
            <div style="font-size: 1.125rem; font-weight: 600;">${app.monthlyIncome.toLocaleString()}</div>
          </div>
          <div>
            <div style="color: hsl(var(--muted-foreground)); font-size: 0.875rem; margin-bottom: 0.25rem;">Repayment History</div>
            <div style="font-size: 1.125rem; font-weight: 600;">${app.repaymentHistory}/5</div>
          </div>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <div style="color: hsl(var(--muted-foreground)); font-size: 0.875rem; margin-bottom: 0.5rem;">Loan Purpose</div>
          <div style="padding: 1rem; background: hsl(var(--muted)); border-radius: 8px; font-size: 0.875rem; line-height: 1.6;">${app.loanPurpose}</div>
        </div>

        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
          <span style="color: hsl(var(--muted-foreground)); font-size: 0.875rem;">Current Status:</span>
          <span class="badge badge-${app.status}">${app.status.charAt(0).toUpperCase() + app.status.slice(1)}</span>
        </div>

        ${app.status === 'pending' ? `
          <div style="display: flex; gap: 1rem;">
            <button class="btn btn-destructive" style="flex: 1;" onclick="updateApplicationStatus('${app.id}', 'rejected')">Reject</button>
            <button class="btn btn-primary" style="flex: 1;" onclick="updateApplicationStatus('${app.id}', 'approved')">Approve</button>
          </div>
        ` : ''}
      </div>
    `;
  }

  function closeModal() {
    document.getElementById('appModal').className = 'hidden';
  }

  function updateApplicationStatus(appId, newStatus) {
    const allApps = JSON.parse(localStorage.getItem('mmAllApplications') || '[]');
    const updatedAllApps = allApps.map(app =>
      app.id === appId ? { ...app, status: newStatus } : app
    );
    localStorage.setItem('mmAllApplications', JSON.stringify(updatedAllApps));

    const app = allApps.find(a => a.id === appId);
    if (app) {
      const borrowerApps = JSON.parse(localStorage.getItem(`mmApplications_${app.borrowerId}`) || '[]');
      const updatedBorrowerApps = borrowerApps.map(a =>
        a.id === appId ? { ...a, status: newStatus } : a
      );
      localStorage.setItem(`mmApplications_${app.borrowerId}`, JSON.stringify(updatedBorrowerApps));
    }

    closeModal();
    loadApplications();
    render();
  }

  init();
</script>
</body>
</html>
